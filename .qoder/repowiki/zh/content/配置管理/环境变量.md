# 环境变量

<cite>
**本文档中引用的文件**  
- [configuration.go](file://conf/configuration.go)
- [root.go](file://cmd/root.go)
- [Dockerfile](file://Dockerfile)
- [aboutUtils.js](file://ui/src/dialogs/aboutUtils.js)
</cite>

## 目录
1. [环境变量配置概述](#环境变量配置概述)
2. [配置优先级逻辑](#配置优先级逻辑)
3. [支持的环境变量列表](#支持的环境变量列表)
4. [环境变量命名规则](#环境变量命名规则)
5. [Docker环境中的使用示例](#docker环境中的使用示例)
6. [调试与验证方法](#调试与验证方法)
7. [安全配置建议](#安全配置建议)

## 环境变量配置概述

Navidrome使用环境变量作为配置管理的重要机制，允许用户在不修改配置文件的情况下动态调整应用程序行为。环境变量提供了一种灵活的配置方式，特别适用于容器化部署场景。通过环境变量，管理员可以覆盖配置文件中的设置，实现快速配置调整和环境特定的定制化。

Navidrome的配置系统基于Viper库实现，支持多种配置源的优先级叠加。环境变量在配置优先级中占据重要位置，能够覆盖配置文件中的相应设置。这种设计使得Navidrome在不同部署环境中具有高度的灵活性和可移植性。

**Section sources**
- [configuration.go](file://conf/configuration.go#L239-L720)
- [root.go](file://cmd/root.go#L347-L404)

## 配置优先级逻辑

Navidrome的配置优先级遵循特定的加载顺序，确保配置的灵活性和可预测性。配置优先级从高到低依次为：命令行参数、环境变量、配置文件、默认值。这种分层配置机制允许用户在不同层级上进行配置覆盖。

在`configuration.go`文件中，通过`InitConfig`函数实现配置初始化。该函数首先设置Viper的环境变量前缀为"ND"，并使用下划线作为键名分隔符。当`loadEnvVars`参数为true时，启用环境变量自动加载功能。Viper库会自动将环境变量映射到相应的配置项。

配置加载过程的关键步骤包括：
1. 首先检查命令行参数
2. 然后加载环境变量（以ND_为前缀）
3. 接着读取配置文件（如navidrome.toml）
4. 最后应用默认值

当同一配置项在多个层级中存在时，优先级较高的层级会覆盖较低层级的设置。例如，如果在环境变量和配置文件中都设置了音乐文件夹路径，环境变量的值将被采用。

**Section sources**
- [configuration.go](file://conf/configuration.go#L671-L719)
- [root.go](file://cmd/root.go#L349)

## 支持的环境变量列表

Navidrome支持广泛的环境变量配置，涵盖了应用程序的各个方面。所有环境变量均以"ND_"为前缀，后跟配置项名称的大写形式，点号（.）用下划线（_）替换。

以下是主要的环境变量及其对应配置项：

| 环境变量 | 配置项 | 默认值 | 描述 |
|---------|-------|-------|------|
| ND_MUSICFOLDER | MusicFolder | ./music | 音乐文件存储目录 |
| ND_DATAFOLDER | DataFolder | . | 应用数据存储目录（数据库） |
| ND_CACHEFOLDER | CacheFolder |  | 缓存数据存储目录 |
| ND_DBPATH | DbPath | data/navidrome.db | 数据库文件路径 |
| ND_PORT | Port | 4533 | HTTP监听端口 |
| ND_ADDRESS | Address | 0.0.0.0 | 绑定IP地址 |
| ND_LOGLEVEL | LogLevel | info | 日志级别（error, info, debug, trace） |
| ND_BASEURL | BaseURL |  | 基础URL，用于代理配置 |
| ND_ENABLEEXTERNALSERVICES | EnableExternalServices | true | 是否启用外部服务集成 |
| ND_ENABLEDOWNLOADS | EnableDownloads | true | 是否启用下载功能 |
| ND_PLAYLISTSPATH | PlaylistsPath |  | 播放列表文件路径 |

此外，还支持嵌套配置项的环境变量，如：
- ND_LASTFM_APIKEY：Last.fm API密钥
- ND_SPOTIFY_ID：Spotify客户端ID
- ND_DEEZER_ENABLED：是否启用Deezer集成
- ND_PROMETHEUS_ENABLED：是否启用Prometheus监控

**Section sources**
- [configuration.go](file://conf/configuration.go#L22-L137)
- [Dockerfile](file://Dockerfile#L136-L139)

## 环境变量命名规则

Navidrome的环境变量遵循统一的命名规范，确保配置的一致性和可预测性。命名规则如下：

1. **前缀规则**：所有环境变量必须以"ND_"为前缀，这是Navidrome的命名空间标识。
2. **大小写规则**：环境变量名称全部使用大写字母。
3. **分隔符规则**：配置项中的点号（.）用下划线（_）替换。
4. **驼峰命名转换**：配置项中的驼峰命名法（CamelCase）保持不变。

例如，配置项`musicFolder`对应的环境变量为`ND_MUSICFOLDER`，而嵌套配置项`lastfm.apiKey`对应的环境变量为`ND_LASTFM_APIKEY`。

在`aboutUtils.js`文件中，可以找到环境变量生成的实现逻辑：
```javascript
const envVar = 'ND_' + currentKey.toUpperCase().replace(/\./g, '_')
```

这种命名规则确保了配置项到环境变量的可预测映射，便于自动化工具生成和管理配置。

**Section sources**
- [aboutUtils.js](file://ui/src/dialogs/aboutUtils.js#L27)
- [configuration.go](file://conf/configuration.go#L693-L696)

## Docker环境中的使用示例

在Docker环境中，Navidrome通过Dockerfile预定义了关键的环境变量，简化了容器化部署的配置过程。Dockerfile中设置了以下默认环境变量：

```dockerfile
ENV ND_MUSICFOLDER=/music
ENV ND_DATAFOLDER=/data
ENV ND_CONFIGFILE=/data/navidrome.toml
ENV ND_PORT=4533
```

使用Docker运行Navidrome的典型示例如下：

```bash
docker run -d \
  --name navidrome \
  -p 4533:4533 \
  -e ND_MUSICFOLDER=/music \
  -e ND_DATAFOLDER=/data \
  -e ND_LOGLEVEL=debug \
  -e ND_BASEURL=/navidrome \
  -v /path/to/music:/music:ro \
  -v /path/to/data:/data \
  deluan/navidrome:latest
```

在docker-compose.yml中配置Navidrome：

```yaml
version: '3'
services:
  navidrome:
    image: deluan/navidrome:latest
    restart: unless-stopped
    ports:
      - "4533:4533"
    environment:
      - ND_MUSICFOLDER=/music
      - ND_DATAFOLDER=/data
      - ND_LOGLEVEL=info
      - ND_BASEURL=/music
    volumes:
      - ./music:/music:ro
      - ./data:/data
```

这些示例展示了如何通过环境变量灵活配置Navidrome实例，适应不同的部署需求。

**Section sources**
- [Dockerfile](file://Dockerfile#L136-L140)
- [root.go](file://cmd/root.go#L352-L365)

## 调试与验证方法

验证环境变量配置是否正确应用是系统管理的重要环节。Navidrome提供了多种调试和验证方法：

1. **日志验证**：启动时，Navidrome会根据配置情况输出相应的日志信息。如果使用环境变量而没有配置文件，会显示：
   ```
   No configuration file found. Loaded configuration only from environment variables
   ```

2. **配置转储**：当日志级别设置为Debug时，Navidrome会输出完整的配置信息，便于验证环境变量是否正确加载。

3. **API端点检查**：通过Navidrome的管理界面或API，可以查看当前生效的配置值。

4. **环境变量检查**：在容器环境中，可以使用`docker exec`命令检查环境变量：
   ```bash
   docker exec navidrome printenv | grep ND_
   ```

5. **配置文件优先级测试**：可以通过创建简单的配置文件并设置环境变量来测试优先级逻辑，验证环境变量是否能正确覆盖配置文件中的设置。

这些调试方法帮助管理员确保配置的正确性，及时发现和解决配置问题。

**Section sources**
- [configuration.go](file://conf/configuration.go#L346-L352)
- [root.go](file://cmd/root.go#L64)

## 安全配置建议

为确保Navidrome环境变量配置的安全性，建议遵循以下最佳实践：

1. **敏感信息保护**：避免在环境变量中直接存储敏感信息如API密钥、密码等。建议使用Docker Secrets或其他安全的密钥管理方案。

2. **权限设置**：确保数据目录和配置文件具有适当的文件权限。在Docker环境中，使用非root用户运行容器。

3. **环境变量验证**：在生产环境中，验证所有环境变量的正确性，避免因配置错误导致服务异常。

4. **配置审计**：定期审查环境变量配置，移除不再需要的配置项，保持配置的简洁性。

5. **备份策略**：即使使用环境变量配置，也建议定期备份配置文件和数据库，确保配置的可恢复性。

6. **最小权限原则**：为Navidrome进程分配最小必要的系统权限，限制其对系统资源的访问。

通过遵循这些安全建议，可以有效降低配置相关的安全风险，确保Navidrome服务的稳定和安全运行。

**Section sources**
- [configuration.go](file://conf/configuration.go#L283-L292)
- [Dockerfile](file://Dockerfile#L135)